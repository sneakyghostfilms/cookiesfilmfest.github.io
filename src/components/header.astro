---
import { Icon } from "astro-icon/components";
import NavLinks from "./nav/NavLinks.astro";
import MobileMenu from "./nav/MobileMenu.astro";
import type { NavItem } from "~/types";

const navItems: Array<NavItem> = [
  { title: "Our Mission", url: "#mission" },
  { title: "The Event", url: "#event" },
  { title: "Awards", url: "#awards" },
  { title: "Submit", url: "#submission" },
  { title: "Contact", url: "#contact" },
];

const pastEvents = [
  { href: "/past-events/2025", text: "2025 Festival" },
];
---

<header
  id="page-header"
  class="absolute bottom-0 z-20 flex w-full items-end justify-between px-6 sm:px-10 pb-4 text-white animate-slide-down"
>
  <div class="flex items-end flex-grow-0">
    <div class="flex items-end gap-3">
      <NavLinks navItems={navItems} pastEvents={pastEvents} />
      <MobileMenu navItems={navItems} pastEvents={pastEvents} />
    </div>
  </div>
  <div class="flex-shrink-0 ml-auto flex items-end">
    <a href="https://www.facebook.com/CookiesAndComedy" target="_blank" class="social-btn">
      <Icon name="mdi:facebook" class="size-5" /> Follow us
    </a>
  </div>
</header>

<script>
  function initHeader() {
    const header = document.querySelector("#page-header") as HTMLElement;
    const page = document.documentElement;

    if (!header) return;

    // Unified function to update header state based on scroll and viewport
    const updateHeaderState = () => {
      const d = page.clientHeight - page.scrollTop - header.offsetHeight;
      const shouldFix = d < 0;
      const isMobile = window.innerWidth <= 1000;

      header.classList.toggle("fixed-header", shouldFix);

      // When fixed at top, remove mobile-header to prevent CSS conflict
      // (mobile-header has bottom: 0 !important which conflicts with fixed-header's top: 0)
      if (shouldFix) {
        header.classList.remove("mobile-header");
      } else if (isMobile) {
        header.classList.add("mobile-header");
      } else {
        header.classList.remove("mobile-header");
      }
    };

    // Update on scroll and resize
    document.addEventListener("scroll", updateHeaderState);
    window.addEventListener('resize', updateHeaderState);

    // Initial state
    updateHeaderState();
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initHeader);
  } else {
    initHeader();
  }
  document.addEventListener('astro:page-load', initHeader);
</script>

<style>
  .fixed-header {
    position: fixed !important;
    bottom: auto !important;
    top: 0 !important;
    @apply border-default bg-default text-default;
    animation: slideDown 0.3s ease forwards;
    box-shadow: var(--shadow-md);
  }

  .social-btn {
    background-color: var(--color-primary);
    color: white;
    padding: 0.75rem 1.5rem;
    border-radius: 2rem;
    font-family: 'Fredoka', sans-serif;
    font-weight: 600;
    font-size: 0.95rem;
    box-shadow: var(--shadow-md);
    text-decoration: none;
    transition: all 0.3s ease;
    white-space: nowrap;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    line-height: 1.5;
    position: relative;
    top: -5px;
    border: 1px solid var(--color-primary-dark);
  }

  .social-btn:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
    background-color: var(--color-primary-dark);
    top: -7px;
  }

  .mobile-header {
    padding-bottom: 2.5rem !important;
    position: fixed !important;
    bottom: 0 !important;
    left: 0;
    right: 0;
    /* No background - stays transparent over dark splash */
  }

  @keyframes slideDown {
    from { transform: translateY(-100%); }
    to { transform: translateY(0); }
  }

  .animate-slide-down {
    animation: slideDown 0.5s ease-out;
  }

  @media (max-width: 640px) {
    /* Only apply fixed bottom positioning when NOT scrolled to top */
    #page-header:not(.fixed-header) {
      padding-bottom: 0.75rem;
      position: fixed !important;
      bottom: 0 !important;
      left: 0;
      right: 0;
      z-index: 50;
    }

    .social-btn {
      font-size: 0.85rem;
      padding: 0.6rem 1rem;
    }
  }
</style>
